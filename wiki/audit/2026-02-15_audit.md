# VizionAI Architecture Audit

## High-Level Diagram (Mermaid)

This is a text diagram you can paste into a Mermaid renderer:

```
flowchart LR
  subgraph VPS[Hostinger VPS]
    SCHED[Central Scheduler\n(vizion-scheduling-runner.timer)] -->gt; DB[(Postgres AIDB)]
    SCHED -->gt; JOBS[sched_job / sched_job_run]
    SCHED -->gt; PLATFORM[vizion-platform\n(plan_from_alerts + dispatch_tasks)]
    PLATFORM -->gt; TASKS[platform_task]
    PLATFORM -->gt; ALERTS[alert_event]
    ALERTS -->gt; FANOUT[vizion-alert-reporting\nfanout_run]
    FANOUT -->gt; N8N[n8n]
    FANOUT -->gt; OC[OpenClaw]
    TRD[vizion-trading] -->gt; ALERTS
    MKT[vizion-marketing] -->gt; ALERTS
    MAINT[vizion-maintenance] -->gt; ALERTS
    ANA[vizion-analytics] -->gt; ALERTS
    NN[vizion-nn.service\n:8000] -->gt; TRD
    VW[Vaultwarden\n:32768] --- UI[(RDP/Xorg Browser)]
  end
```

## Orchestration

- Single orchestrator timer expected:vizion-scheduling-runner.timer
- Scheduler writes jobs tosched_joband executes allowlisted job types
### Systemd Timers

```
Failed to connect to bus: Operation not permitted
```

### Systemd Services

```
Failed to connect to bus: Operation not permitted
```

## Runtime Services (Docker)

```
permission denied while trying to connect to the docker API at unix:///var/run/docker.sock
```

## Listening Ports

```
Cannot open netlink socket: Operation not permitted
6:LISTEN 0      0            0.0.0.0:8000       0.0.0.0:*          
7:LISTEN 0      0            0.0.0.0:48950      0.0.0.0:*          
9:LISTEN 0      0            0.0.0.0:32770      0.0.0.0:*          
10:LISTEN 0      0            0.0.0.0:32768      0.0.0.0:*          
11:LISTEN 0      0            0.0.0.0:32769      0.0.0.0:*          
15:LISTEN 0      0                  *:48950            *:*          
16:LISTEN 0      0                  *:32770            *:*          
17:LISTEN 0      0                  *:32768            *:*          
18:LISTEN 0      0                  *:32769            *:*          
```

## Health Checks

- NN:http://127.0.0.1:8000/health
- OpenClaw:http://127.0.0.1:48950/
- n8n:http://127.0.0.1:32769/
- Vaultwarden:http://127.0.0.1:32768/
### NN Health JSON

```

```

### HTTP HEAD (OpenClaw / n8n / Vaultwarden)

```

```

## Workspaces

### Workspace Directories

```
2:vizion-agent-builder
3:vizion-alert-reporting
4:vizion-analytics
5:vizion-maintenance
6:vizion-marketing
7:vizion-platform
8:vizion-scheduling
9:vizion-trading
```

### Workspace Git State

```
== vizion-agent-builder ==
remote=git@github.com:VizionCorpAI/vizion-agent-builder.git
branch=main
dirty=1

== vizion-alert-reporting ==
remote=git@github.com:VizionCorpAI/vizion-alert-reporting.git
branch=main
dirty=1

== vizion-analytics ==
remote=git@github.com:VizionCorpAI/vizion-analytics.git
branch=main
dirty=2

== vizion-maintenance ==
remote=git@github.com:VizionCorpAI/vizion-maintenance.git
branch=main
dirty=1

== vizion-marketing ==
remote=git@github.com:VizionCorpAI/vizion-marketing.git
branch=main
dirty=3

== vizion-platform ==
remote=git@github.com:VizionCorpAI/vizion-platform.git
branch=main
dirty=5

== vizion-scheduling ==
remote=git@github.com:VizionCorpAI/vizion-scheduling.git
branch=main
dirty=0

== vizion-trading ==
remote=git@github.com:VizionCorpAI/vizion-trading.git
branch=main
dirty=3
```

## Registry Alignment

Potential drift:there is a legacy registry SQL underWORKSPACES/infra/sqlthat still references old paths/remotes (e.g./root/VizionAI/AGENTS/TRADING/REPOandsahrxvision). The platform registry is authoritative.

### Platform Registry (workspaces.csv)

```
workspace_key,agent_key,repo_name,repo_path,repo_remote,workflow_namespace,db_name,db_schema,db_table_prefix,status
trading,trading,vizion-trading,/root/VizionAI/WORKSPACES/vizion-trading,git@github.com:VizionCorpAI/vizion-trading.git,trading,AIDB,public,trade_,active
scheduling,scheduling,vizion-scheduling,/root/VizionAI/WORKSPACES/vizion-scheduling,git@github.com:VizionCorpAI/vizion-scheduling.git,scheduling,AIDB,public,sched_,active
marketing,marketing,vizion-marketing,/root/VizionAI/WORKSPACES/vizion-marketing,git@github.com:VizionCorpAI/vizion-marketing.git,marketing,AIDB,public,mkt_,active
agent_builder,builder,vizion-agent-builder,/root/VizionAI/WORKSPACES/vizion-agent-builder,git@github.com:VizionCorpAI/vizion-agent-builder.git,agent_builder,AIDB,public,agent_,active
analytics,analytics,vizion-analytics,/root/VizionAI/WORKSPACES/vizion-analytics,git@github.com:VizionCorpAI/vizion-analytics.git,analytics,AIDB,public,analytics_,active
maintenance,maintenance,vizion-maintenance,/root/VizionAI/WORKSPACES/vizion-maintenance,git@github.com:VizionCorpAI/vizion-maintenance.git,maintenance,AIDB,public,maint_,active
alert_reporting,alert,vizion-alert-reporting,/root/VizionAI/WORKSPACES/vizion-alert-reporting,git@github.com:VizionCorpAI/vizion-alert-reporting.git,alert_reporting,AIDB,public,alert_,active
```

### Workspace Dependencies (workspace_dependencies.csv)

```
from_workspace,to_workspace,dependency_type,notes
scheduling,trading,read_signals,Uses trading bias/state for schedule gating
marketing,analytics,read_metrics,Uses analytics KPI rollups for campaign optimization
analytics,trading,read_trades,Aggregates trading outcomes for reporting
agent_builder,scheduling,provision_agent,Creates scheduling agents/templates
agent_builder,marketing,provision_agent,Creates marketing agents/templates
agent_builder,trading,provision_agent,Creates trading agent modules/templates
analytics,scheduling,read_jobs,Tracks run and SLA metrics
marketing,trading,read_bias,Aligns outbound content bias with market bias
trading,analytics,write_metrics,Publishes trade outcomes to analytics warehouse
trading,scheduling,publish_jobs,Publishes trade-calendar jobs for scheduling agents
alert_reporting,trading,read_trades,Consumes trading outcomes and state/bias reports
alert_reporting,analytics,read_metrics,Consumes analytics KPIs and rollups
alert_reporting,marketing,read_campaigns,Consumes marketing workflow events and campaign results
alert_reporting,scheduling,read_jobs,Consumes scheduling run history and SLA metrics
platform,alert_reporting,read_alerts,Consumes normalized telemetry stream from alert-reporting
scheduling,platform,read_tasks,Consumes platform-dispatched tasks and executes them on schedule
scheduling,alert_reporting,read_alerts,Consumes alert/report events for escalation scheduling
analytics,alert_reporting,read_alerts,Consumes raw alert_event snapshots for analytics views/rollups
analytics,platform,read_tasks,Consumes platform_task queue/run history for analytics
analytics,scheduling,read_jobs,Consumes scheduling run history for analytics
```

### Legacy Registry SQL (for cleanup/redirect)

```
CREATE TABLE IF NOT EXISTS workspace_repo_registry (
  id BIGSERIAL PRIMARY KEY,
  workspace_key TEXT NOT NULL UNIQUE,
  agent_key TEXT NOT NULL,
  repo_name TEXT NOT NULL,
  repo_path TEXT NOT NULL,
  repo_remote TEXT NOT NULL,
  workflow_namespace TEXT NOT NULL,
  db_name TEXT NOT NULL,
  db_schema TEXT NOT NULL DEFAULT 'public',
  db_table_prefix TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'active',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE OR REPLACE FUNCTION touch_workspace_repo_registry_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_workspace_repo_registry_updated_at ON workspace_repo_registry;
CREATE TRIGGER trg_workspace_repo_registry_updated_at
BEFORE UPDATE ON workspace_repo_registry
FOR EACH ROW EXECUTE FUNCTION touch_workspace_repo_registry_updated_at();

INSERT INTO workspace_repo_registry (
  workspace_key, agent_key, repo_name, repo_path, repo_remote, workflow_namespace,
  db_name, db_schema, db_table_prefix, status
) VALUES
  ('trading','trading','profitgtx','/root/VizionAI/AGENTS/TRADING/REPO','git@github.com:sahrxvision/profitgtx.git','trading','AIDB','public','trade_','active'),
  ('scheduling','scheduling','vizion-scheduling','/root/VizionAI/WORKSPACES/vizion-scheduling','git@github.com:sahrxvision/vizion-scheduling.git','scheduling','AIDB','public','sched_','active'),
  ('marketing','marketing','vizion-marketing','/root/VizionAI/WORKSPACES/vizion-marketing','git@github.com:sahrxvision/vizion-marketing.git','marketing','AIDB','public','mkt_','active'),
  ('agent_builder','builder','vizion-agent-builder','/root/VizionAI/WORKSPACES/vizion-agent-builder','git@github.com:sahrxvision/vizion-agent-builder.git','agent_builder','AIDB','public','agent_','active'),
  ('analytics','analytics','vizion-analytics','/root/VizionAI/WORKSPACES/vizion-analytics','git@github.com:sahrxvision/vizion-analytics.git','analytics','AIDB','public','analytics_','active')
ON CONFLICT (workspace_key) DO UPDATE
SET agent_key = EXCLUDED.agent_key,
    repo_name = EXCLUDED.repo_name,
    repo_path = EXCLUDED.repo_path,
    repo_remote = EXCLUDED.repo_remote,
    workflow_namespace = EXCLUDED.workflow_namespace,
    db_name = EXCLUDED.db_name,
    db_schema = EXCLUDED.db_schema,
    db_table_prefix = EXCLUDED.db_table_prefix,
    status = EXCLUDED.status;
```

## OpenClaw Skills Sync

OpenClaw skill directory on host:/docker/openclaw-xbkt/data/skills

```
total 48
drwxr-xr-x 12 ubuntu ubuntu 4096 Feb 15 07:17 .
drwxr-xr-x  9 ubuntu ubuntu 4096 Feb 13 09:35 ..
drwxr-xr-x 11 ubuntu ubuntu 4096 Feb 13 09:35 metals-desk-os
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:16 vizion-agent-builder
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-alert-reporting
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-analytics
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-maintenance
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-marketing
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 13 09:36 vizion-nn
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-platform
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-scheduling
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-trading
```

## Findings / Recommendations

- Keep scheduler as the only recurring systemd timer; ensure per-workspace timers remain disabled.
- Resolve git DNS failures if they recur (observed previously as transient).
- Converge legacy infra SQL registry to the platform registry or remove it to avoid confusion.
- Vaultwarden: configureADMIN_TOKENusing an Argon2 PHC hash (Vaultwarden logs warn about plaintext token).