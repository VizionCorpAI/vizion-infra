<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VizionAI Architecture Audit (2026-02-16)</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.35; margin: 28px; color: #111; }
    h1,h2,h3 { margin: 0.6em 0 0.2em; }
    .meta { color: #444; font-size: 0.95em; margin-bottom: 16px; }
    .box { border: 1px solid #ddd; padding: 12px 14px; border-radius: 8px; margin: 10px 0 18px; }
    pre { background: #0b1020; color: #e8eefc; padding: 12px; border-radius: 8px; overflow: auto; font-size: 12px; }
    code { background: #f2f2f2; padding: 2px 4px; border-radius: 4px; }
    .warn { background: #fff7ed; border: 1px solid #fed7aa; }
    .ok { background: #f0fdf4; border: 1px solid #bbf7d0; }
    ul { margin-top: 6px; }
  </style>
</head>
<body>
  <h1>VizionAI Architecture Audit</h1>
  <div class="meta">
    Date (UTC): <b>2026-02-16</b><br/>
    Host: <code>srv1079950</code><br/>
    Scope: Workspaces, orchestration, containers, ports, and registry alignment.
  </div>

  <h2>High-Level Diagram (Mermaid)</h2>
  <div class="box">
    <p>This is a text diagram you can paste into a Mermaid renderer:</p>
    <pre>flowchart LR
  subgraph VPS[Hostinger VPS]
    SCHED[Central Scheduler\n(vizion-scheduling-runner.timer)] -->gt; DB[(Postgres AIDB)]
    SCHED -->gt; JOBS[sched_job / sched_job_run]
    SCHED -->gt; PLATFORM[vizion-platform\n(plan_from_alerts + dispatch_tasks)]
    PLATFORM -->gt; TASKS[platform_task]
    PLATFORM -->gt; ALERTS[alert_event]
    ALERTS -->gt; FANOUT[vizion-alert-reporting\nfanout_run]
    FANOUT -->gt; N8N[n8n]
    FANOUT -->gt; OC[OpenClaw]
    TRD[vizion-trading] -->gt; ALERTS
    MKT[vizion-marketing] -->gt; ALERTS
    MAINT[vizion-maintenance] -->gt; ALERTS
    ANA[vizion-analytics] -->gt; ALERTS
    NN[vizion-nn.service\n:8000] -->gt; TRD
    VW[Vaultwarden\n:32768] --- UI[(RDP/Xorg Browser)]
  end</pre>
  </div>

  <h2>Orchestration</h2>
  <div class="box ok">
    <ul>
      <li>Single orchestrator timer expected: <code>vizion-scheduling-runner.timer</code></li>
      <li>Scheduler writes jobs to <code>sched_job</code> and executes allowlisted job types</li>
    </ul>
  </div>

  <h3>Systemd Timers</h3>
  <pre>Failed to connect to bus: Operation not permitted</pre>

  <h3>Systemd Services</h3>
  <pre>Failed to connect to bus: Operation not permitted</pre>

  <h2>Runtime Services (Docker)</h2>
  <pre>permission denied while trying to connect to the docker API at unix:///var/run/docker.sock</pre>

  <h2>Listening Ports</h2>
  <pre>Cannot open netlink socket: Operation not permitted
4:LISTEN 0      0            0.0.0.0:32768      0.0.0.0:*          
5:LISTEN 0      0            0.0.0.0:32769      0.0.0.0:*          
9:LISTEN 0      0            0.0.0.0:48950      0.0.0.0:*          
10:LISTEN 0      0            0.0.0.0:8000       0.0.0.0:*          
13:LISTEN 0      0                  *:32768            *:*          
14:LISTEN 0      0                  *:32769            *:*          
18:LISTEN 0      0                  *:48950            *:*          </pre>

  <h2>Health Checks</h2>
  <div class="box">
    <ul>
      <li>NN: <code>http://127.0.0.1:8000/health</code></li>
      <li>OpenClaw: <code>http://127.0.0.1:48950/</code></li>
      <li>n8n: <code>http://127.0.0.1:32769/</code></li>
      <li>Vaultwarden: <code>http://127.0.0.1:32768/</code></li>
    </ul>
  </div>
  <h3>NN Health JSON</h3>
  <pre></pre>
  <h3>HTTP HEAD (OpenClaw / n8n / Vaultwarden)</h3>
  <pre></pre>

  <h2>Workspaces</h2>
  <h3>Workspace Directories</h3>
  <pre>1:vizion-agent-builder
2:vizion-alert-reporting
3:vizion-analytics
4:vizion-infra
5:vizion-maintenance
6:vizion-marketing
7:vizion-platform
8:vizion-scheduling
9:vizion-security
10:vizion-trading</pre>

  <h3>Workspace Git State</h3>
  <pre>== vizion-agent-builder ==
remote=git@github.com:VizionCorpAI/vizion-agent-builder.git
branch=main
dirty=2

== vizion-alert-reporting ==
remote=git@github.com:VizionCorpAI/vizion-alert-reporting.git
branch=main
dirty=2

== vizion-analytics ==
remote=git@github.com:VizionCorpAI/vizion-analytics.git
branch=main
dirty=3

== vizion-infra ==
remote=git@github.com:VizionCorpAI/vizion-infra.git
branch=main
dirty=38

== vizion-maintenance ==
remote=git@github.com:VizionCorpAI/vizion-maintenance.git
branch=main
dirty=17

== vizion-marketing ==
remote=git@github.com:VizionCorpAI/vizion-marketing.git
branch=main
dirty=4

== vizion-platform ==
remote=git@github.com:VizionCorpAI/vizion-platform.git
branch=main
dirty=0

== vizion-scheduling ==
remote=git@github.com:VizionCorpAI/vizion-scheduling.git
branch=main
dirty=3

== vizion-security ==
remote=git@github.com:VizionCorpAI/vizion-security.git
branch=main
dirty=3

== vizion-trading ==
remote=git@github.com:VizionCorpAI/vizion-trading.git
branch=main
dirty=4</pre>

  <h2>Registry Alignment</h2>
  <div class="box warn">
    <p><b>Potential drift:</b> there is a legacy registry SQL under <code>WORKSPACES/vizion-infra/sql/legacy</code> that still references old paths/remotes (e.g. <code>/root/VizionAI/AGENTS/TRADING/REPO</code> and <code>sahrxvision</code>). The platform registry is authoritative.</p>
  </div>

  <h3>Platform Registry (workspaces.csv)</h3>
  <pre>workspace_key,agent_key,repo_name,repo_path,repo_remote,workflow_namespace,db_name,db_schema,db_table_prefix,status
trading,trading,vizion-trading,/root/VizionAI/WORKSPACES/vizion-trading,git@github.com:VizionCorpAI/vizion-trading.git,trading,AIDB,public,trade_,active
scheduling,scheduling,vizion-scheduling,/root/VizionAI/WORKSPACES/vizion-scheduling,git@github.com:VizionCorpAI/vizion-scheduling.git,scheduling,AIDB,public,sched_,active
marketing,marketing,vizion-marketing,/root/VizionAI/WORKSPACES/vizion-marketing,git@github.com:VizionCorpAI/vizion-marketing.git,marketing,AIDB,public,mkt_,active
agent_builder,builder,vizion-agent-builder,/root/VizionAI/WORKSPACES/vizion-agent-builder,git@github.com:VizionCorpAI/vizion-agent-builder.git,agent_builder,AIDB,public,agent_,active
analytics,analytics,vizion-analytics,/root/VizionAI/WORKSPACES/vizion-analytics,git@github.com:VizionCorpAI/vizion-analytics.git,analytics,AIDB,public,analytics_,active
maintenance,maintenance,vizion-maintenance,/root/VizionAI/WORKSPACES/vizion-maintenance,git@github.com:VizionCorpAI/vizion-maintenance.git,maintenance,AIDB,public,maint_,active
alert_reporting,alert,vizion-alert-reporting,/root/VizionAI/WORKSPACES/vizion-alert-reporting,git@github.com:VizionCorpAI/vizion-alert-reporting.git,alert_reporting,AIDB,public,alert_,active
infra,infra,vizion-infra,/root/VizionAI/WORKSPACES/vizion-infra,git@github.com:VizionCorpAI/vizion-infra.git,infra,AIDB,public,infra_,active
security,security,vizion-security,/root/VizionAI/WORKSPACES/vizion-security,git@github.com:VizionCorpAI/vizion-security.git,security,AIDB,public,sec_,active</pre>

  <h3>Workspace Dependencies (workspace_dependencies.csv)</h3>
  <pre>from_workspace,to_workspace,dependency_type,notes
scheduling,trading,read_signals,Uses trading bias/state for schedule gating
marketing,analytics,read_metrics,Uses analytics KPI rollups for campaign optimization
analytics,trading,read_trades,Aggregates trading outcomes for reporting
agent_builder,scheduling,provision_agent,Creates scheduling agents/templates
agent_builder,marketing,provision_agent,Creates marketing agents/templates
agent_builder,trading,provision_agent,Creates trading agent modules/templates
analytics,scheduling,read_jobs,Tracks run and SLA metrics
marketing,trading,read_bias,Aligns outbound content bias with market bias
trading,analytics,write_metrics,Publishes trade outcomes to analytics warehouse
trading,scheduling,publish_jobs,Publishes trade-calendar jobs for scheduling agents
alert_reporting,trading,read_trades,Consumes trading outcomes and state/bias reports
alert_reporting,analytics,read_metrics,Consumes analytics KPIs and rollups
alert_reporting,marketing,read_campaigns,Consumes marketing workflow events and campaign results
alert_reporting,scheduling,read_jobs,Consumes scheduling run history and SLA metrics
platform,alert_reporting,read_alerts,Consumes normalized telemetry stream from alert-reporting
scheduling,platform,read_tasks,Consumes platform-dispatched tasks and executes them on schedule
scheduling,alert_reporting,read_alerts,Consumes alert/report events for escalation scheduling
analytics,alert_reporting,read_alerts,Consumes raw alert_event snapshots for analytics views/rollups
analytics,platform,read_tasks,Consumes platform_task queue/run history for analytics
analytics,scheduling,read_jobs,Consumes scheduling run history for analytics
security,alert_reporting,read_alerts,Consumes alert events for threat correlation
security,platform,read_policies,Reads platform policies for enforcement
platform,security,dispatch_tasks,Dispatches security audit and compliance tasks
security,trading,audit_secrets,Audits trading credential lifecycle
security,marketing,audit_secrets,Audits marketing credential lifecycle
security,analytics,audit_secrets,Audits analytics credential lifecycle</pre>

  <h3>Legacy Registry SQL (for cleanup/redirect)</h3>
  <pre>CREATE TABLE IF NOT EXISTS workspace_repo_registry (
  id BIGSERIAL PRIMARY KEY,
  workspace_key TEXT NOT NULL UNIQUE,
  agent_key TEXT NOT NULL,
  repo_name TEXT NOT NULL,
  repo_path TEXT NOT NULL,
  repo_remote TEXT NOT NULL,
  workflow_namespace TEXT NOT NULL,
  db_name TEXT NOT NULL,
  db_schema TEXT NOT NULL DEFAULT 'public',
  db_table_prefix TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'active',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE OR REPLACE FUNCTION touch_workspace_repo_registry_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_workspace_repo_registry_updated_at ON workspace_repo_registry;
CREATE TRIGGER trg_workspace_repo_registry_updated_at
BEFORE UPDATE ON workspace_repo_registry
FOR EACH ROW EXECUTE FUNCTION touch_workspace_repo_registry_updated_at();

INSERT INTO workspace_repo_registry (
  workspace_key, agent_key, repo_name, repo_path, repo_remote, workflow_namespace,
  db_name, db_schema, db_table_prefix, status
) VALUES
  ('trading','trading','profitgtx','/root/VizionAI/AGENTS/TRADING/REPO','git@github.com:sahrxvision/profitgtx.git','trading','AIDB','public','trade_','active'),
  ('scheduling','scheduling','vizion-scheduling','/root/VizionAI/WORKSPACES/vizion-scheduling','git@github.com:sahrxvision/vizion-scheduling.git','scheduling','AIDB','public','sched_','active'),
  ('marketing','marketing','vizion-marketing','/root/VizionAI/WORKSPACES/vizion-marketing','git@github.com:sahrxvision/vizion-marketing.git','marketing','AIDB','public','mkt_','active'),
  ('agent_builder','builder','vizion-agent-builder','/root/VizionAI/WORKSPACES/vizion-agent-builder','git@github.com:sahrxvision/vizion-agent-builder.git','agent_builder','AIDB','public','agent_','active'),
  ('analytics','analytics','vizion-analytics','/root/VizionAI/WORKSPACES/vizion-analytics','git@github.com:sahrxvision/vizion-analytics.git','analytics','AIDB','public','analytics_','active')
ON CONFLICT (workspace_key) DO UPDATE
SET agent_key = EXCLUDED.agent_key,
    repo_name = EXCLUDED.repo_name,
    repo_path = EXCLUDED.repo_path,
    repo_remote = EXCLUDED.repo_remote,
    workflow_namespace = EXCLUDED.workflow_namespace,
    db_name = EXCLUDED.db_name,
    db_schema = EXCLUDED.db_schema,
    db_table_prefix = EXCLUDED.db_table_prefix,
    status = EXCLUDED.status;</pre>

  <h2>OpenClaw Skills Sync</h2>
  <div class="box">
    <p>OpenClaw skill directory on host: <code>/docker/openclaw-xbkt/data/skills</code></p>
  </div>
  <pre>total 56
drwxr-xr-x 14 ubuntu ubuntu 4096 Feb 15 19:04 .
drwxr-xr-x  9 ubuntu ubuntu 4096 Feb 13 09:35 ..
drwxr-xr-x 11 ubuntu ubuntu 4096 Feb 13 09:35 metals-desk-os
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:16 vizion-agent-builder
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-alert-reporting
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-analytics
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 19:47 vizion-infra
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-maintenance
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-marketing
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 13 09:36 vizion-nn
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-platform
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-scheduling
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 17:15 vizion-security
drwxr-xr-x  3 ubuntu ubuntu 4096 Feb 15 07:17 vizion-trading</pre>

  <h2>Findings / Recommendations</h2>
  <div class="box">
    <ul>
      <li>Keep scheduler as the only recurring systemd timer; ensure per-workspace timers remain disabled.</li>
      <li>Resolve git DNS failures if they recur (observed previously as transient).</li>
      <li>Converge legacy infra SQL registry to the platform registry or remove it to avoid confusion.</li>
      <li>Vaultwarden: configure <code>ADMIN_TOKEN</code> using an Argon2 PHC hash (Vaultwarden logs warn about plaintext token).</li>
    </ul>
  </div>
</body>
</html>
